esphome:
  name: lilygo
  platformio_options:
    # Unless noted otherwise, based on https://github.com/Xinyuan-LilyGO/LilyGo-EPD47/blob/1eb6119fc31fcff7a6bafecb09f4225313859fc5/examples/demo/platformio.ini#L37
    upload_speed: 921600
    monitor_speed: 115200
    board_build.mcu: esp32s3
    board_build.f_cpu: 240000000L
    board_build.arduino.memory_type: qspi_opi
    board_build.flash_size: 16MB
    board_build.flash_mode: qio
    board_build.flash_type: qspi
    board_build.psram_type: opi
    board_build.memory_type: qspi_opi
    board_build.boot_freq: 80m
    build_flags:  # the first three defines are required for the screen library to function.
      - "-DBOARD_HAS_PSRAM"
      - "-DARDUINO_RUNNING_CORE=0"  # TODO: this conflicts with the value from platformio's idedata, spewing a lot of warnings during the build.
      - "-DARDUINO_EVENT_RUNNING_CORE=0"  # and this too
      # In addition to lilygo's settings:
      # To enable reading logs over USB until `hardware_uart: USB_CDC` support
      # is added to `logger:`, as detailed in <https://github.com/esphome/feature-requests/issues/1906>:
      - "-DARDUINO_USB_MODE=1"
      - "-DARDUINO_USB_CDC_ON_BOOT=1"

esp32:
  variant: esp32s3
  board: esp32-s3-devkitc-1

  framework:
    type: arduino
    # Just like in <https://community.home-assistant.io/t/enable-usb-cdc-to-log-hello-world-to-esp32-s3-dev-board-for-esphome/463164/10>
    # I had problems with newer versions; the following combination happens to work, so using it for now.
    version: 2.0.3
    platform_version: 5.1.1


 
web_server:
  port: 80
  include_internal: true 


i2c:
  sda: GPIO17
  scl: GPIO18
  # There is some problems with i2c scan so turn scan off if problem appear on your board
  scan: false
  id: bus_a

external_components:
  - source: github://nickolay/esphome-lilygo-t547plus
    components: ["t547"]



  


wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password


  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Esp32-Ttgo-Display"
    password: "gRYvBmC4Bmog"

mqtt:
  broker: !secret mqtt_host
  username: !secret mqtt_username
  password: !secret mqtt_password



font:
  - file: "gfonts://Source Sans Pro@bold"
    id: font_name
    size: 38
  - file: "gfonts://Source Sans Pro"
    id: font_value
    size: 56    
  - file: "gfonts://Source Sans Pro"
    id: font_footer
    size: 28    

    # https://pictogrammers.github.io/@mdi/font/5.3.45/
  - file: 'fonts/materialdesignicons-webfont.ttf'
    id: font_icons
    size: 160
    glyphs:
      - "\U000F0594" # clear-night
      - "\U000F0590" # cloudy
      - "\U000F0595" # partlycloudy
      - "\U000F0591" # fog      
      - "\U000F0592" # hail
      - "\U000F0593" # lightning
      - "\U000F067E" # lightning-rainy
      - "\U000F0596" # pouring
      - "\U000F0597" # rainy
      - "\U000F0F36" # snowy
      - "\U000F067F" # snowy-rainy
      - "\U000F0599" # sunny
      - "\U000F059D" # windy
      - "\U000F059E" # windy-variant
      - "\U000F0F38" # exceptional
      
  - file: 'fonts/materialdesignicons-webfont.ttf'
    id: font_icons_small
    size: 56
    glyphs:
      - "\U000F10C2" # Temperature High
      - "\U000F10C3" # Temperature Low
      - "\U000F07E4" # CO2
      - "\U000F054B" # umbrella      
      - "\U000F0592" # hail
      - "\U000F0593" # lightning
      - "\U000F067E" # lightning-rainy
      - "\U000F0597" # rainy
      - "\U000F0F36" # snowy
      - "\U000F0594" # clear-night
      - "\U000F0599" # sunny
      - "\U000F07CA" # fuel
      - "\U000F024A" # flower
      - "\U000F051F" # time-remaining
      - "\U000F140B" # Energy
      - "\U000F0A72" # solar power
      - "\U000F0D9B" # solar-panel
      - "\U000F0F9B" # mdi-home-export-outline
      - "\U000F0F9C" # mdi-home-import-outline
button:
  - platform: restart
    name: "${esp_name} Restart"

  - platform: template
    name: "${esp_name} Refresh"
    icon: "mdi:update"
    on_press:
      then:
      - component.update: t5_display

binary_sensor:
  - platform: gpio
    pin: 
      number: GPIO39
      inverted: true
    name: "${esp_name} Button 1"
    on_press:
      then:
        - component.update: t5_display
      
  - platform: gpio
    pin: 
      number: GPIO34
      inverted: true
    name: "${esp_name} Button 2"

  - platform: gpio
    pin: 
      number: GPIO35
      inverted: true
    name: "${esp_name} Button 3"


sensor:
  - platform: mqtt_subscribe
    name: "aktuelle Temperatur"
    id: ext_temp
    topic: weather/current/temperature/state  

  - platform: mqtt_subscribe
    name: "Niederschlagswahrscheinlichkeit"
    id: prec_perc
    topic: weather/today/precipprobability/state  

  - platform: mqtt_subscribe
    name: "Regen"
    id: prec_rain
    topic: weather/today/rain/state  


    
  - platform: mqtt_subscribe
    name: "Vorhersage Temperatur Minimum"
    id: fc_low
    topic: weather/today/mintemperature/state  


  - platform: mqtt_subscribe
    name: "Vorhersage Temperatur Maximum"
    id: fc_high
    topic: weather/today/maxtemperature/state  
    

  - platform: mqtt_subscribe
    name: "Wohnzimmer Temperatur"
    id: lr_temp
    topic: livingroom/sensor/temperature/state  

  - platform: mqtt_subscribe
    name: "Wetter Condition ID"
    topic: weather/today/conditionid/state
    id: fc_weather
    internal: true



  - platform: mqtt_subscribe
    name: "Netz"
    id: netz
    topic: pv/sensor/netz/state 

  - platform: mqtt_subscribe
    name: "Eigen"
    id: eigen
    topic: pv/sensor/eigenverbrauch/state   



  - platform: mqtt_subscribe
    name: "PV1 Leistung"
    id: pv1_leistung
    topic: pv/sensor/pv1/state

  - platform: mqtt_subscribe
    name: "PV1 Tagesertrag"
    id: pv1_tagesertrag
    topic: pv/sensor/pv1_tagesertrag/state

  - platform: mqtt_subscribe
    name: "PV2 Leistung"
    id: pv2_leistung
    topic: pv/sensor/pv2/state

  - platform: mqtt_subscribe
    name: "PV2 Tagesertrag"
    id: pv2_tagesertrag
    topic: pv/sensor/pv2_tagesertrag/state

  - platform: mqtt_subscribe
    name: "PV3 Leistung"
    id: pv3_leistung
    topic: pv/sensor/pv3/state

  - platform: mqtt_subscribe
    name: "PV3 Tagesertrag"
    id: pv3_tagesertrag
    topic: pv/sensor/pv3_tagesertrag/state

  - platform: mqtt_subscribe
    name: "PV4 Leistung"
    id: pv4_leistung
    topic: pv/sensor/pv4/state

  - platform: mqtt_subscribe
    name: "PV4 Tagesertrag"
    id: pv4_tagesertrag
    topic: pv/sensor/pv4_tagesertrag/state
    on_value: # Ausgef체hrt wenn der letzte Sensorwert empfangen wurde
      then:
        - script.execute: all_data_received     





  - platform: adc
    pin: GPIO14
    name: "${esp_name} Battery Voltage"
    id: batt_volt
    attenuation: 11db
    update_interval: never
    filters:
      - multiply: 2

  - platform: template
    name: "${esp_name} Battery"
    id: batt
    unit_of_measurement: "%"
    accuracy_decimals: 0
    device_class: battery
    lambda: |-
      int y = (1-(4.1-id(batt_volt).state)/(4.1-3.3))*100;
      if (y < 100) {return y;} else {return 100;};
    update_interval: never



    



script:
  - id: all_data_received
    then:
      - component.update: batt_volt
      - component.update: batt
      - component.update: t5_display
      - if: 
          condition:
              lambda: |- 
                if (id(batt_volt).state>4.5) { 
                  return false;
                }
                else{
                  return true;
                } 
          then:
              - script.execute: enter_sleep     

  - id: enter_sleep
    then:
        - if:
            condition:
              lambda: |- 
                auto time = id(ntp).now();
                if (!time.is_valid()) { 
                  return false;
                }
                return (time.hour < 6); 
            then:
              - logger.log: "It's nighttime, entering long sleep for ${night_sleep_time}"          

            else:
              - logger.log: "It's daytime, entering short sleep for ${sleep_time}"             


display:
  - platform: t547 #t547
    id: st547
    rotation: 270
    update_interval: never
    lambda: |-
      #define xres 540 
      #define yres 960
      #define x_pad 10 // border padding
      #define y_pad 10 // border padding      
      #define cat_pad 70 // padding before category
      #define val_pad 60 // padding before value
      #define icon_pad 35 //padding after icons      
      #define x1n 20 //x position 1st column name
      #define x1v 25 //x position 1st column value
      #define x1i 50 //x position 1st column icon
      #define x2n xres/2 //x position 2nd column name
      #define x2v xres/2 //x position 2nd column value
      #define x2i xres/2 //x position 1st column icon
      
      int y = 0;
      
      // Date
      it.strftime(xres/2, y+y_pad, id(font_name), TextAlign::TOP_CENTER, "%d.%m.%Y", id(ntp).now());
      y+=val_pad+cat_pad+10;

      #define weather_icon_x xres/4-x_pad
      #define gauge_radius 85
      #define gauge_thickness 5

      //Weather forecast Icon

      if (id(fc_weather).state == 800) { //clear night
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0594");}
      if (id(fc_weather).state >= 802 && id(fc_weather).state <= 804) { // cloudy
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0590");}
      if (id(fc_weather).state == 801) { //partlycloudy
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0595");}
      if (id(fc_weather).state == 741) { // fog
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0591");}
      if (id(fc_weather).state == 511) { //hail
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0592");}
      if (id(fc_weather).state >= 210 && id(fc_weather).state <= 232) { //lightning
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0593");}
      if (id(fc_weather).state >= 200 && id(fc_weather).state <= 209) { //lightning-rainy
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F067E");}
      if (id(fc_weather).state >= 300 && id(fc_weather).state <= 321) {//pouring
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0596");}
      if (id(fc_weather).state >= 500 && id(fc_weather).state <= 510) { //rainy
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0597");}
      if (id(fc_weather).state >= 600 && id(fc_weather).state <= 614)  { //snowy
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0F36");}
      if (id(fc_weather).state >= 615 && id(fc_weather).state <= 616)  { //snowy-rainy
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F067F");}
      if (id(fc_weather).state == 0) { //sunny
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0599");}
      if (id(fc_weather).state == 0) { //windy
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F059D");}
      if (id(fc_weather).state == 0) {//windy-variant
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F059E");}
      if (id(fc_weather).state == 0) { //exceptional
      it.printf(weather_icon_x, y, id(font_icons), TextAlign::CENTER, "\U000F0F38");} 
      
      // High/Low Temperature
      it.printf(x2i+30, y-15, id(font_icons_small), TextAlign::BASELINE_CENTER, "\U000F10C2"); // temp high
      it.printf(x2i+30+icon_pad, y-10, id(font_value), TextAlign::BASELINE_LEFT, "%.1f 째C", id(fc_high).state);
      it.printf(x2i+30, y+15, id(font_icons_small), TextAlign::TOP_CENTER, "\U000F10C3"); // temp low
      it.printf(x2i+30+icon_pad, y+10, id(font_value),  TextAlign::TOP_LEFT, "%.1f 째C", id(fc_low).state);
      y+=cat_pad+50;


      // Outside Temp + Precipitation
      it.print(x1n, y, id(font_name), TextAlign::BASELINE_LEFT, "Aussen");
      it.print(x2n, y, id(font_name), TextAlign::BASELINE_LEFT, "Niederschlag");
      y+=val_pad;      
      it.printf(x1v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.1f 째C", id(ext_temp).state);
      it.printf(x2v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.0fmm/%3.0f %%", id(prec_rain).state, id(prec_perc).state);
      
      //Divider
      #define div_pad 40
      #define div_thickness 4
      it.filled_rectangle(x_pad, y+div_pad, xres-2*x_pad, div_thickness);
      
      y+=div_pad*2+div_thickness;


      //Netz
      it.print(x1n, y, id(font_name), TextAlign::BASELINE_LEFT, "Netz");
      it.print(x2n, y, id(font_name), TextAlign::BASELINE_LEFT, "Eigenverbrauch"); //CO2
      y+= val_pad;      
      it.printf(x1v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.0f W", id(netz).state);
      it.printf(x2v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.0f W", id(eigen).state);      
      y += cat_pad;
      

      //PV1
      it.print(x1n, y, id(font_name), TextAlign::BASELINE_LEFT, "PV1");
      y+= val_pad;      
      it.printf(x1v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.0f W", id(pv1_leistung).state);
      it.printf(x2v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.0f kWp", id(pv1_tagesertrag).state);
      y += cat_pad;
  
      //PV2
      it.print(x1n, y, id(font_name), TextAlign::BASELINE_LEFT, "PV2");
      y+= val_pad;      
      it.printf(x1v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.0f W", id(pv2_leistung).state);
      it.printf(x2v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.0f kWp", id(pv2_tagesertrag).state);
      y += cat_pad;

      //PV3
      it.print(x1n, y, id(font_name), TextAlign::BASELINE_LEFT, "PV3");
      y+= val_pad;      
      it.printf(x1v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.0f W", id(pv3_leistung).state);
      it.printf(x2v, y, id(font_value), TextAlign::BASELINE_LEFT, "%.0f kWp", id(pv3_tagesertrag).state);
      y += cat_pad;



      // Footer
      it.strftime(x_pad, yres-y_pad/2, id(font_footer), TextAlign::BASELINE_LEFT, "Updated: %H:%M", id(ntp).now());
      it.printf(xres-x_pad, yres-y_pad/2, id(font_footer), TextAlign::BASELINE_RIGHT, "%.2fV/%.0f%%", id(batt_volt).state, id(batt).state);