  #https://github.com/danuw/esphome-configs/blob/epd-multipage/epd47-1.yaml
  #https://github.com/esphome/feature-requests/issues/1960
  # kWh anzeige 08.12.2023
  
  
  substitutions:
    esp_name: ESP32 T7-4.7 Display D10 #Device Name
    esp_hostname: esp32-t5-47-d10
    run_time: 5min #can be as long as needed to get data 
    sleep_time: 20min # normal sleep time
    night_sleep_time: 6h # 1st sleep time after midnight
    
  #esphome:
   # name: ${esp_hostname}
    #platform: ESP32
    #board: esp32dev
  esphome:
    name: ${esp_hostname}
  
  esp32:
    board: esp32dev
    framework:
      #type: esp-idf
      type: arduino
  

  psram:
    mode: quad
    speed: 40MHz

  external_components:
#    - source: github://tiaanv/esphome-components
#      components: ["t547"]
#    - source:
#        type: git
#        url: https://github.com/vbaksa/esphome
#        ref: dev
    #- source: github://martin-at-schorsch/esphome-toshiba-hvac  # Ersetze durch dein Repository!
    #  components: ["lilygo_t5_47_display", "epdiy"]
    #  refresh: 0s
    - source:
        type: local
        path: components
      components: [lilygo_t5_47_display, "epdiy"]
  
  wifi:
    ssid: !secret wifi_ssid
    password: !secret wifi_password

  
  deep_sleep:
     run_duration: ${run_time} 
     sleep_duration: ${sleep_time}
     id: deep_sleep_1
     esp32_ext1_wakeup:
       pins: GPIO39
       mode: ALL_LOW
  
  
  
  web_server:
    port: 80
    include_internal: true 
  
  ota:
    - platform: esphome
      password: 12345511d
  
  # Enable logging
  logger:
  
  # Enable Home Assistant API
  api:
    encryption:
      key: "NtaH+2oXk6+yxdMAl8uAqioADAFL5YEYFdbvsmTTM8Q="
  
  time:
    - platform: sntp
      id: ntp
      timezone: "Europe/Vienna"

  mqtt:
    broker: !secret mqtt_host
    username: !secret mqtt_username
    password: !secret mqtt_password


  
  font:
    - file: "gfonts://Source Sans Pro@bold"
      id: font_name
      size: 38
    - file: "gfonts://Source Sans Pro"
      id: font_value
      size: 56    
    - file: "gfonts://Source Sans Pro"
      id: font_footer
      size: 28    
  
      # https://pictogrammers.github.io/@mdi/font/5.3.45/
    - file: 'fonts/materialdesignicons-webfont.ttf'
      id: font_icons
      size: 160
      glyphs:
        - "\U000F0594" # clear-night
        - "\U000F0590" # cloudy
        - "\U000F0595" # partlycloudy
        - "\U000F0591" # fog      
        - "\U000F0592" # hail
        - "\U000F0593" # lightning
        - "\U000F067E" # lightning-rainy
        - "\U000F0596" # pouring
        - "\U000F0597" # rainy
        - "\U000F0F36" # snowy
        - "\U000F067F" # snowy-rainy
        - "\U000F0599" # sunny
        - "\U000F059D" # windy
        - "\U000F059E" # windy-variant
        - "\U000F0F38" # exceptional
        
    - file: 'fonts/materialdesignicons-webfont.ttf'
      id: font_icons_small
      size: 56
      glyphs:
        - "\U000F10C2" # Temperature High
        - "\U000F10C3" # Temperature Low
        - "\U000F07E4" # CO2
        - "\U000F054B" # umbrella      
        - "\U000F0592" # hail
        - "\U000F0593" # lightning
        - "\U000F067E" # lightning-rainy
        - "\U000F0597" # rainy
        - "\U000F0F36" # snowy
        - "\U000F0594" # clear-night
        - "\U000F0599" # sunny
        - "\U000F07CA" # fuel
        - "\U000F024A" # flower
        - "\U000F051F" # time-remaining
        - "\U000F140B" # Energy
        - "\U000F0A72" # solar power
        - "\U000F0D9B" # solar-panel
        - "\U000F0F9B" # mdi-home-export-outline
        - "\U000F0F9C" # mdi-home-import-outline
  button:
    - platform: restart
      name: "${esp_name} Restart"
  
    - platform: template
      name: "${esp_name} Refresh"
      icon: "mdi:update"
      on_press:
        then:
        - component.update: t5_display
  
  binary_sensor:
#    - platform: gpio
#      pin: 
#        number: GPIO39
#        inverted: true
#      name: "${esp_name} Button 1"
#      on_press:
#        then:
#         - component.update: t5_display
        
    - platform: gpio
      pin: 
        number: GPIO34
        inverted: true
      name: "${esp_name} Button 2"
  
    - platform: gpio
      pin: 
        number: GPIO35
        inverted: true
      name: "${esp_name} Button 3"
  
  
  sensor:
    - platform: mqtt_subscribe
      name: "aktuelle Temperatur"
      id: ext_temp
      topic: weather/current/temperature/state  

    - platform: mqtt_subscribe
      name: "Niederschlagswahrscheinlichkeit"
      id: prec_perc
      topic: weather/today/precipprobability/state  
  
    - platform: mqtt_subscribe
      name: "Regen"
      id: prec_rain
      topic: weather/today/rain/state  


      
    - platform: mqtt_subscribe
      name: "Vorhersage Temperatur Minimum"
      id: fc_low
      topic: weather/today/mintemperature/state  


    - platform: mqtt_subscribe
      name: "Vorhersage Temperatur Maximum"
      id: fc_high
      topic: weather/today/maxtemperature/state  
      


    - platform: mqtt_subscribe
      name: "Wetter Condition ID"
      topic: weather/today/conditionid/state
      id: fc_weather
      internal: true



    - platform: mqtt_subscribe
      name: "Netz"
      id: netz
      topic: pv/sensor/netz/state 

    - platform: mqtt_subscribe
      name: "Eigen"
      id: eigen
      topic: pv/sensor/eigenverbrauch/state   



    - platform: mqtt_subscribe
      name: "PV1 Leistung"
      id: pv1_leistung
      topic: pv/sensor/pv1/state

    - platform: mqtt_subscribe
      name: "PV1 Tagesertrag"
      id: pv1_tagesertrag
      topic: pv/sensor/pv1_tagesertrag/state

    - platform: mqtt_subscribe
      name: "PV2 Leistung"
      id: pv2_leistung
      topic: pv/sensor/pv2/state

    - platform: mqtt_subscribe
      name: "PV2 Tagesertrag"
      id: pv2_tagesertrag
      topic: pv/sensor/pv2_tagesertrag/state

    - platform: mqtt_subscribe
      name: "PV3 Leistung"
      id: pv3_leistung
      topic: pv/sensor/pv3/state

    - platform: mqtt_subscribe
      name: "PV3 Tagesertrag"
      id: pv3_tagesertrag
      topic: pv/sensor/pv3_tagesertrag/state

    - platform: mqtt_subscribe
      name: "PV4 Leistung"
      id: pv4_leistung
      topic: pv/sensor/pv4/state

    - platform: mqtt_subscribe
      name: "PV4 Tagesertrag"
      id: pv4_tagesertrag
      topic: pv/sensor/pv4_tagesertrag/state
      on_value: # Ausgef체hrt wenn der letzte Sensorwert empfangen wurde
        then:
          - script.execute: all_data_received     


  
  
  
    - platform: adc
      pin: GPIO36
      name: "${esp_name} Battery Voltage"
      id: batt_volt
      attenuation: 12db
      update_interval: never
      filters:
        - multiply: 2
  
    - platform: template
      name: "${esp_name} Battery"
      id: batt
      unit_of_measurement: "%"
      accuracy_decimals: 0
      device_class: battery
      lambda: |-
        int y = (1-(4.1-id(batt_volt).state)/(4.1-3.3))*100;
        if (y < 100) {return y;} else {return 100;};
      update_interval: never
  
  

      
 

  
  script:
    - id: all_data_received
      then:
        - component.update: batt_volt
        - component.update: batt
        - component.update: t5_display
        - if: 
            condition:
               lambda: |- 
                  if (id(batt_volt).state>4.5) { 
                    return false;
                  }
                  else{
                    return true;
                  } 
            then:
               - script.execute: enter_sleep     
  
    - id: enter_sleep
      then:
         - if:
             condition:
               lambda: |- 
                 auto time = id(ntp).now();
                 if (!time.is_valid()) { 
                   return false;
                 }
                 return (time.hour < 6); 
             then:
               - logger.log: "It's nighttime, entering long sleep for ${night_sleep_time}"          
               - deep_sleep.enter: 
                   id: deep_sleep_1 
                   sleep_duration: ${night_sleep_time}
             else:
               - logger.log: "It's daytime, entering short sleep for ${sleep_time}"             
               - deep_sleep.enter: 
                   id: deep_sleep_1 
                   sleep_duration: ${sleep_time}
          
  
  display:
    - platform: lilygo_t5_47_display #t547
      id: t5_display
      rotation: 270
      update_interval: never
      lambda: |-
        #define xres 540 
        #define yres 960
        #define x_pad 10 // border padding
        #define y_pad 10 // border padding      
        #define cat_pad 70 // padding before category
        #define val_pad 60 // padding before value
        #define icon_pad 35 //padding after icons      
        #define x1n 20 //x position 1st column name
        #define x1v 25 //x position 1st column value
        #define x1i 50 //x position 1st column icon
        #define x2n xres/2 //x position 2nd column name
        #define x2v xres/2 //x position 2nd column value
        #define x2i xres/2 //x position 1st column icon
        
        int y = 0;
        
        // Date
        it.strftime(xres/2, y+y_pad, id(font_name), TextAlign::TOP_CENTER, "%d.%m.%Y d10", id(ntp).now());
        y+=val_pad+cat_pad+10;
  
        #define weather_icon_x xres/4-x_pad
        #define gauge_radius 85
        #define gauge_thickness 5
  
        //Weather forecast Icon
  
        if (id(fc_weather).state == 800) { //clear night
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER,  "\U000F0594");}
        if (id(fc_weather).state >= 802 && id(fc_weather).state <= 804) { // cloudy
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER,  "\U000F0590");}
        if (id(fc_weather).state == 801) { //partlycloudy
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER,  "\U000F0595");}
        if (id(fc_weather).state == 741) { // fog
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER,  "\U000F0591");}
        if (id(fc_weather).state == 511) { //hail
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER,"\U000F0592");}
        if (id(fc_weather).state >= 210 && id(fc_weather).state <= 232) { //lightning
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F0593");}
        if (id(fc_weather).state >= 200 && id(fc_weather).state <= 209) { //lightning-rainy
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F067E");}
        if (id(fc_weather).state >= 300 && id(fc_weather).state <= 321) {//pouring
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F0596");}
        if (id(fc_weather).state >= 500 && id(fc_weather).state <= 510) { //rainy
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F0597");}
        if (id(fc_weather).state >= 600 && id(fc_weather).state <= 614)  { //snowy
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F0F36");}
        if (id(fc_weather).state >= 615 && id(fc_weather).state <= 616)  { //snowy-rainy
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F067F");}
        if (id(fc_weather).state == 0) { //sunny
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F0599");}
        if (id(fc_weather).state == 0) { //windy
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F059D");}
        if (id(fc_weather).state == 0) {//windy-variant
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F059E");}
        if (id(fc_weather).state == 0) { //exceptional
        it.printf(weather_icon_x, y, id(font_icons),Color::BLACK, TextAlign::CENTER, "\U000F0F38");} 
        
        // High/Low Temperature
        it.printf(x2i+30, y-15, id(font_icons_small),Color::BLACK, TextAlign::BASELINE_CENTER, "\U000F10C2"); // temp high
        it.printf(x2i+30+icon_pad, y-10, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.1f 째C", id(fc_high).state);
        it.printf(x2i+30, y+15, id(font_icons_small),Color::BLACK, TextAlign::TOP_CENTER, "\U000F10C3"); // temp low
        it.printf(x2i+30+icon_pad, y+10, id(font_value),Color::BLACK,  TextAlign::TOP_LEFT, "%.1f 째C", id(fc_low).state);
        y+=cat_pad+50;
  
  
        // Outside Temp + Precipitation
        it.print(x1n, y, id(font_name),Color::BLACK, TextAlign::BASELINE_LEFT, "Aussen");
        it.print(x2n, y, id(font_name),Color::BLACK, TextAlign::BASELINE_LEFT, "Niederschlag");
        y+=val_pad;      
        it.printf(x1v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.1f 째C", id(ext_temp).state);
        it.printf(x2v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.0fmm/%3.0f %%", id(prec_rain).state, id(prec_perc).state);
        
        //Divider
        #define div_pad 40
        #define div_thickness 4
        it.filled_rectangle(x_pad, y+div_pad, xres-2*x_pad, div_thickness, Color::BLACK);
        
        y+=div_pad*2+div_thickness;


        //Netz
        it.print(x1n, y, id(font_name),Color::BLACK, TextAlign::BASELINE_LEFT, "Netz");
        it.print(x2n, y, id(font_name),Color::BLACK, TextAlign::BASELINE_LEFT, "Eigenverbrauch"); //CO2
        y+= val_pad;      
        it.printf(x1v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.0f W", id(netz).state);
        it.printf(x2v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.0f W", id(eigen).state);      
        y += cat_pad;
        

        //PV1
        it.print(x1n, y, id(font_name),Color::BLACK, TextAlign::BASELINE_LEFT, "PV1");
        y+= val_pad;      
        it.printf(x1v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.0f W", id(pv1_leistung).state);
        it.printf(x2v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.0f kWh", id(pv1_tagesertrag).state);
        y += cat_pad;
    
        //PV2
        it.print(x1n, y, id(font_name),Color::BLACK, TextAlign::BASELINE_LEFT, "PV2");
        y+= val_pad;      
        it.printf(x1v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.0f W", id(pv2_leistung).state);
        it.printf(x2v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.0f kWh", id(pv2_tagesertrag).state);
        y += cat_pad;

        //PV3
        it.print(x1n, y, id(font_name),Color::BLACK, TextAlign::BASELINE_LEFT, "PV3");
        y+= val_pad;      
        it.printf(x1v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.0f W", id(pv3_leistung).state);
        it.printf(x2v, y, id(font_value),Color::BLACK, TextAlign::BASELINE_LEFT, "%.0f kWh", id(pv3_tagesertrag).state);
        y += cat_pad;



        // Footer
        it.strftime(x_pad, yres-y_pad/2, id(font_footer),Color::BLACK, TextAlign::BASELINE_LEFT, "Updated: %H:%M", id(ntp).now());
        it.printf(xres-x_pad, yres-y_pad/2, id(font_footer),Color::BLACK, TextAlign::BASELINE_RIGHT, "%.2fV/%.0f%%", id(batt_volt).state, id(batt).state);